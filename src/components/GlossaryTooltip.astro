---
// Glossary definitions - can be expanded as needed
// To add nested terms, include <span data-glossary="TERM">word</span> in the definition string
const glossary: Record<string, string> = {
  'MOSFETs': 'Metal-Oxide-Semiconductor Field-Effect Transistor',
  'MOSFET': 'Metal-Oxide-Semiconductor Field-Effect Transistor',
  'PID': 'Proportional-Integral-Derivative',
  'MPC': 'Model Predictive Control',
  'RL': 'Reinforcement Learning',
  'IMU': 'Inertial Measurement Unit',
  'MIMO': 'Multiple Input Multiple Output',
  'RTOS': 'Real-Time Operating System',
  'SLAM': 'Simultaneous Localization and Mapping',
  'TF-IDF': 'Term Frequency-Inverse Document Frequency',
};
---

<script is:inline>
  (function() {
    const glossary = {
      'MOSFETs': 'Metal-Oxide-Semiconductor Field-Effect Transistor - a type of <span data-glossary="transistor">transistor</span> used for switching and amplifying electronic signals',
      'MOSFET': 'Metal-Oxide-Semiconductor Field-Effect Transistor - a type of <span data-glossary="transistor">transistor</span> used for switching and amplifying electronic signals',
      'transistor': 'A semiconductor device that can amplify or switch electronic signals',
      'PID': 'Proportional-Integral-Derivative',
      'MPC': 'Model Predictive Control',
      'RL': 'Reinforcement Learning',
      'IMU': 'Inertial Measurement Unit',
      'MIMO': 'Multiple Input Multiple Output',
      'RTOS': 'Real-Time Operating System',
      'SLAM': 'Simultaneous Localization and Mapping',
      'TF-IDF': 'Term Frequency-Inverse Document Frequency',
    };
    
    function createTooltip(element, definition) {
      // Check if tooltip already exists
      if (element.querySelector('.glossary-tooltip')) return;
      
      // Ensure element has proper styling
      element.style.position = 'relative';
      element.style.display = 'inline';
      element.style.cursor = 'help';
      element.classList.add('glossary-term');
      
      // Create tooltip container
      const tooltip = document.createElement('div');
      tooltip.className = 'glossary-tooltip';
      tooltip.innerHTML = definition;
      tooltip.setAttribute('role', 'tooltip');
      tooltip.setAttribute('aria-hidden', 'true');
      // Ensure tooltip is a block element and removed from flow
      tooltip.style.display = 'none';
      tooltip.style.position = 'absolute';
      tooltip.style.boxSizing = 'border-box';
      tooltip.style.background = 'rgba(255, 255, 255, 0.9)';
      tooltip.style.backdropFilter = 'blur(4px)';
      tooltip.style.webkitBackdropFilter = 'blur(4px)';
      
      // Append tooltip to element
      element.appendChild(tooltip);
      
      // Handle nested glossary terms in tooltip
      parseNestedTerms(tooltip);
      
      // Show/hide on hover
      element.addEventListener('mouseenter', function() {
        tooltip.style.display = 'block';
        // Trigger animation
        requestAnimationFrame(() => {
          tooltip.classList.add('tooltip-visible');
        });
      });
      
      element.addEventListener('mouseleave', function() {
        tooltip.classList.remove('tooltip-visible');
        // Hide after animation
        setTimeout(() => {
          tooltip.style.display = 'none';
        }, 200);
      });
    }
    
    function parseNestedTerms(container) {
      const terms = container.querySelectorAll('[data-glossary]');
      terms.forEach((term) => {
        const termKey = term.getAttribute('data-glossary');
        if (termKey && glossary[termKey]) {
          createTooltip(term, glossary[termKey]);
        }
      });
    }
    
    function initializeGlossary() {
      const terms = document.querySelectorAll('[data-glossary]');
      terms.forEach((term) => {
        const termKey = term.getAttribute('data-glossary');
        if (termKey && glossary[termKey]) {
          createTooltip(term, glossary[termKey]);
        }
      });
    }
    
    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeGlossary);
    } else {
      initializeGlossary();
    }
    
    // Re-initialize after Astro ViewTransitions
    document.addEventListener('astro:page-load', initializeGlossary);
  })();
</script>

<style>
  .glossary-term {
    border-bottom: 1px dotted currentColor;
    text-decoration: none;
    transition: color 0.2s;
    position: relative;
    display: inline;
    vertical-align: baseline;
  }
  
  .glossary-term:hover {
    color: #111827;
  }
  
  .glossary-tooltip {
    position: absolute !important;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%) translateY(4px) scale(0.95);
    background: rgba(255, 255, 255, 0.9) !important;
    color: #111827;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 0.875rem;
    line-height: 1.5;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
    max-width: 320px;
    white-space: normal;
    word-wrap: break-word;
    display: block;
    box-sizing: border-box;
    /* Ensure tooltip is completely removed from document flow */
    margin: 0;
    width: max-content;
    min-width: 200px;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  
  .glossary-tooltip.tooltip-visible {
    opacity: 1 !important;
    transform: translateX(-50%) translateY(0) scale(1);
    pointer-events: auto;
  }
  
  /* Speech bubble arrow */
  .glossary-tooltip::after {
    content: '' !important;
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border: 8px solid transparent;
    border-top-color: rgba(255, 255, 255, 0.9);
    filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
    display: block;
  }
  
  .glossary-tooltip.tooltip-visible::after {
    display: block !important;
  }
  
  /* Handle nested glossary terms in tooltips */
  .glossary-tooltip .glossary-term {
    border-bottom-color: rgba(17, 24, 39, 0.3);
    color: #2563eb;
  }
  
  .glossary-tooltip .glossary-term:hover {
    color: #1d4ed8;
  }
  
  /* Prevent tooltip from affecting text flow */
  .glossary-term .glossary-tooltip {
    /* Remove from normal flow completely - ensure it's absolutely positioned */
    position: absolute !important;
    /* When hidden, it should not affect layout at all */
    display: none;
    /* Ensure background is always applied */
    background: rgba(255, 255, 255, 0.9) !important;
  }
  
  .glossary-term .glossary-tooltip.tooltip-visible {
    display: block !important;
    opacity: 1 !important;
    background: rgba(255, 255, 255, 0.9) !important;
  }
</style>
