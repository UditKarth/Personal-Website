---
import BaseLayout from '../../layouts/BaseLayout.astro';
import GlossaryTooltip from '../../components/GlossaryTooltip.astro';
import { getCollection } from 'astro:content';
import { readFile } from 'fs/promises';
import { join } from 'path';

export async function getStaticPaths() {
  const writings = await getCollection('writings');
  return writings.map((writing) => ({
    params: { slug: writing.slug },
    props: { writing },
  }));
}

const { writing } = Astro.props;
const { Content } = await writing.render();

// Extract first image from markdown if no image is specified in frontmatter
async function extractFirstImage(slug: string): Promise<string | undefined> {
  try {
    const filePath = join(process.cwd(), 'src', 'content', 'writings', `${slug}.md`);
    const markdown = await readFile(filePath, 'utf-8');
    const imageRegex = /!\[.*?\]\((.*?\.(png|jpg|jpeg|gif|webp))\)/i;
    const match = markdown.match(imageRegex);
    if (match && match[1]) {
      const imagePath = match[1];
      // If it's a relative path like "images/xxx.png", convert to public path
      if (imagePath.startsWith('images/')) {
        return `/writings-images/${imagePath.replace('images/', '')}`;
      }
      // If it's already an absolute URL or public path, return as is
      if (imagePath.startsWith('http') || imagePath.startsWith('/')) {
        return imagePath;
      }
      // Otherwise, assume it's a public path
      return imagePath.startsWith('/') ? imagePath : `/${imagePath}`;
    }
  } catch (error) {
    // If file can't be read, just return undefined
    console.warn(`Could not read markdown file for ${slug}:`, error);
  }
  return undefined;
}

// Get image from frontmatter or extract from markdown
const image = writing.data.image || await extractFirstImage(writing.slug);
---

<BaseLayout
  title={`${writing.data.title} â€” Writings`}
  description={writing.data.description}
  image={image}
>
  <div class="container mx-auto px-6">
    <article class="max-w-3xl mx-auto">
      <header class="mb-section animate-fade-in-up">
        <h1 class="text-hero font-bold mb-4 tracking-tight">
          {writing.data.title}
        </h1>
        <div class="flex items-center gap-4 flex-wrap text-sm font-mono text-gray-600">
          <time datetime={writing.data.pubDate.toISOString()}>
            {writing.data.pubDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}
          </time>
          <span class="px-2 py-1 bg-gray-100 rounded">
            {writing.data.status}
          </span>
          {writing.data.tags.length > 0 && (
            <div class="flex items-center gap-2 flex-wrap">
              {writing.data.tags.map((tag) => (
                <span class="px-2 py-1 bg-gray-100 rounded">
                  {tag}
                </span>
              ))}
            </div>
          )}
        </div>
      </header>

      <div class="text-lg text-gray-700 leading-relaxed space-y-6 animate-fade-in-up [&_h2]:text-2xl [&_h2]:font-semibold [&_h2]:mt-8 [&_h2]:mb-4 [&_h2]:text-gray-900 [&_h3]:text-xl [&_h3]:font-semibold [&_h3]:mt-6 [&_h3]:mb-3 [&_h3]:text-gray-900 [&_p]:mb-4 [&_ul]:list-disc [&_ul]:ml-6 [&_ul]:mb-4 [&_ol]:list-decimal [&_ol]:ml-6 [&_ol]:mb-4 [&_li]:mb-2 [&_code]:bg-gray-100 [&_code]:px-1.5 [&_code]:py-0.5 [&_code]:rounded [&_code]:text-sm [&_code]:font-mono [&_pre]:bg-gray-50 [&_pre]:border [&_pre]:border-gray-200 [&_pre]:p-4 [&_pre]:rounded [&_pre]:overflow-x-auto [&_pre]:mb-4 [&_pre]:text-gray-900 [&_pre_code]:bg-transparent [&_pre_code]:p-0 [&_a]:text-gray-900 [&_a]:underline [&_a]:hover:text-gray-600 [&_.katex]:text-[1.1em] [&_.katex-display]:my-6 [&_.katex-display]:overflow-x-auto">
        <Content />
      </div>
      
      <GlossaryTooltip />
    </article>
  </div>
</BaseLayout>

